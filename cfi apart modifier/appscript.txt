// ========================================
// ‚úÖ VERSION ULTRA-SIMPLIFI√âE - 1 IMAGE SEULEMENT
// ========================================

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    Logger.log('üì• Requ√™te re√ßue - Action: ' + (data.action || 'CREATE_ARTICLE'));
    
    // Actions sp√©ciales
    if (data.action === 'increment_views') {
      return handleCorsResponse(incrementViews(data));
    }
    
    if (data.action === 'increment_likes') {
      return handleCorsResponse(incrementLikes(data));
    }
    
    if (data.action === 'add_comment') {
      return handleCorsResponse(addComment(data));
    }

    var sheet = SpreadsheetApp.openById('17fea_nma-6ZpZHa1fCfNBjJUSSvL1rRjwumruMO0-cM').getActiveSheet();
    
    // Cr√©ation d'un nouvel article
    if (!data.action) {
      return handleCorsResponse(createNewArticle(sheet, data));
    }

    // Update d'article
    if (data.action === 'update') {
      return handleCorsResponse(updateArticle(sheet, data));
    }

    // Delete article
    if (data.action === 'delete') {
      return handleCorsResponse(deleteArticle(sheet, data));
    }

    // Reorder article
    if (data.action === 'reorder') {
      return handleCorsResponse(reorderArticle(sheet, data));
    }

    throw new Error('Action non reconnue: ' + data.action);
    
  } catch (error) {
    Logger.log('‚ùå ERREUR doPost: ' + error.toString());
    return handleCorsResponse({ 
      success: false, 
      error: error.toString() 
    });
  }
}

// ========================================
// üÜï CR√âER UN NOUVEL ARTICLE (IMAGES MULTIPLES)
// ========================================
function createNewArticle(sheet, data) {
  try {
    ensureColumnsExist(sheet);
    
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    var newId = generateSimpleId(sheet);
    
    var newRow = [];
    
    for (var i = 0; i < headers.length; i++) {
      var header = headers[i];
      var value = '';
      
      switch(header) {
        case 'id':
          value = newId;
          break;
        case 'date':
          value = new Date();
          break;
        case 'image':
          // üî• PREMI√àRE IMAGE = COUVERTURE
          value = data.image || '';
          break;
        case 'images':
          // üî• TOUTES LES IMAGES EN JSON STRINGIFI√â
          // On re√ßoit d√©j√† une string JSON, on la sauvegarde directement
          value = data.images || '[]';
          break;
        case 'vue':
        case 'likes':
          value = 0;
          break;
        case 'section':
          value = data.section || 'main';
          break;
        case 'contentType':
          value = data.contentType || 'article';
          break;
        case 'video_url':
          value = data.video_url || '';
          break;
        default:
          value = data[header] || '';
      }
      
      newRow.push(value);
    }
    
    sheet.appendRow(newRow);
    
    Logger.log('‚úÖ Article cr√©√© avec ID: ' + newId);
    Logger.log('üì∏ Images: ' + (data.images ? JSON.parse(data.images).length + ' images' : 'Aucune'));
    
    return { 
      success: true, 
      message: 'Article ajout√© avec ID: ' + newId,
      newId: newId 
    };
    
  } catch (error) {
    Logger.log('‚ùå Erreur cr√©ation article: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

// ========================================
// ‚úèÔ∏è METTRE √Ä JOUR UN ARTICLE (IMAGES MULTIPLES)
// ========================================
function updateArticle(sheet, data) {
  try {
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    var rows = sheet.getDataRange().getValues();
    
    var idIndex = headers.indexOf('id');
    if (idIndex === -1) throw new Error('Colonne ID non trouv√©e');
    
    for (var i = 1; i < rows.length; i++) {
      if (String(rows[i][idIndex]) === String(data.id)) {
        
        for (var j = 0; j < headers.length; j++) {
          var header = headers[j];
          
          if (header === 'image' && data.image !== undefined) {
            // üî• METTRE √Ä JOUR L'IMAGE DE COUVERTURE
            sheet.getRange(i + 1, j + 1).setValue(data.image);
          } else if (header === 'images' && data.images !== undefined) {
            // üî• METTRE √Ä JOUR TOUTES LES IMAGES (JSON STRINGIFI√â)
            sheet.getRange(i + 1, j + 1).setValue(data.images);
          } else if (data[header] !== undefined && header !== 'id') {
            sheet.getRange(i + 1, j + 1).setValue(data[header]);
          }
        }
        
        Logger.log('‚úÖ Article mis √† jour: ' + data.id);
        return { success: true, message: 'Article mis √† jour' };
      }
    }
    
    throw new Error('Article introuvable: ' + data.id);
    
  } catch (error) {
    Logger.log('‚ùå Erreur update article: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

// ========================================
// üõ†Ô∏è S'ASSURER QUE LA COLONNE IMAGES EXISTE
// ========================================
function ensureColumnsExist(sheet) {
  var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  var requiredColumns = [
    'id', 'date', 'titre', 'categorie', 'section', 'contentType',
    'image', 'images', 'extrait', 'contenu', 'auteur', 'video_url', 'vue', 'likes'
  ];
  
  var missingColumns = requiredColumns.filter(function(col) {
    return headers.indexOf(col) === -1;
  });
  
  if (missingColumns.length > 0) {
    var lastCol = sheet.getLastColumn();
    missingColumns.forEach(function(col, index) {
      sheet.getRange(1, lastCol + index + 1).setValue(col);
    });
    Logger.log('‚úÖ Colonnes ajout√©es: ' + missingColumns.join(', '));
  }
}

// ========================================
// üóëÔ∏è SUPPRIMER UN ARTICLE
// ========================================
function deleteArticle(sheet, data) {
  try {
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    var rows = sheet.getDataRange().getValues();
    
    var idIndex = headers.indexOf('id');
    if (idIndex === -1) throw new Error('Colonne ID non trouv√©e');
    
    for (var i = 1; i < rows.length; i++) {
      if (String(rows[i][idIndex]) === String(data.id)) {
        sheet.deleteRow(i + 1);
        Logger.log('‚úÖ Article supprim√©: ' + data.id);
        return { success: true, message: 'Article supprim√©' };
      }
    }
    
    throw new Error('Article introuvable: ' + data.id);
    
  } catch (error) {
    Logger.log('‚ùå Erreur delete article: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

// ========================================
// üîÑ R√âORGANISER UN ARTICLE
// ========================================
function reorderArticle(sheet, data) {
  try {
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    var rows = sheet.getDataRange().getValues();
    
    var idIndex = headers.indexOf('id');
    if (idIndex === -1) throw new Error('Colonne ID non trouv√©e');
    
    for (var i = 1; i < rows.length; i++) {
      if (String(rows[i][idIndex]) === String(data.id)) {
        var currentRow = i + 1;
        
        if (data.direction === 'up' && i > 1) {
          sheet.moveRows(sheet.getRange(currentRow, 1, 1, sheet.getLastColumn()), currentRow - 1);
        } else if (data.direction === 'down' && i < rows.length - 1) {
          sheet.moveRows(sheet.getRange(currentRow, 1, 1, sheet.getLastColumn()), currentRow + 2);
        }
        
        Logger.log('‚úÖ Article r√©organis√©: ' + data.id);
        return { success: true, message: 'Ordre modifi√©' };
      }
    }
    
    throw new Error('Article introuvable: ' + data.id);
    
  } catch (error) {
    Logger.log('‚ùå Erreur reorder article: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

// ========================================
// üìñ FONCTION doGet (LECTURE)
// ========================================
function doGet(e) {
  try {
    var action = e.parameter.action;
    var articleId = e.parameter.article_id;
    
    if (action === 'get_comments' && articleId) {
      return handleCorsResponse(getApprovedComments(articleId));
    }
    
    var sheet = SpreadsheetApp.openById('17fea_nma-6ZpZHa1fCfNBjJUSSvL1rRjwumruMO0-cM').getActiveSheet();
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    var jsonData = [];

    for (var i = 1; i < data.length; i++) {
      if (data[i].join('').trim() === '') continue;
      
      var row = data[i];
      var article = {};
      
      for (var j = 0; j < headers.length; j++) {
        article[headers[j]] = row[j];
      }
      
      article.likes = parseInt(article.likes) || 0;
      article.vue = parseInt(article.vue) || 0;
      
      jsonData.push(article);
    }

    Logger.log('‚úÖ ' + jsonData.length + ' articles charg√©s');
    return handleCorsResponse({ 
      success: true, 
      data: jsonData,
      count: jsonData.length 
    });

  } catch (error) {
    Logger.log('‚ùå ERREUR doGet: ' + error.toString());
    return handleCorsResponse({ 
      success: false, 
      error: error.toString() 
    });
  }
}

// ========================================
// üõ†Ô∏è FONCTIONS UTILITAIRES
// ========================================

function handleCorsResponse(responseObj) {
  return ContentService
    .createTextOutput(JSON.stringify(responseObj))
    .setMimeType(ContentService.MimeType.JSON);
}

function generateSimpleId(sheet) {
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var idIndex = headers.indexOf('id');
  
  var maxId = 0;
  for (var i = 1; i < data.length; i++) {
    if (data[i].join('').trim() === '') continue;
    var currentId = parseInt(data[i][idIndex]) || 0;
    if (currentId > maxId) maxId = currentId;
  }
  
  return String(maxId + 1);
}



// ========================================
// üëÅÔ∏è INCR√âMENTER LES VUES
// ========================================
function incrementViews(data) {
  try {
    var sheet = SpreadsheetApp.openById('17fea_nma-6ZpZHa1fCfNBjJUSSvL1rRjwumruMO0-cM').getActiveSheet();
    var rows = sheet.getDataRange().getValues();
    var headers = rows[0];
    
    var idIndex = headers.indexOf('id');
    var vueIndex = headers.indexOf('vue');
    
    for (var i = 1; i < rows.length; i++) {
      if (String(rows[i][idIndex]) === String(data.id)) {
        var currentViews = parseInt(rows[i][vueIndex]) || 0;
        var newViews = currentViews + 1;
        sheet.getRange(i + 1, vueIndex + 1).setValue(newViews);
        
        return { success: true, newViews: newViews };
      }
    }
    
    throw new Error('Article non trouv√©: ' + data.id);
    
  } catch (error) {
    Logger.log('‚ùå Erreur incrementViews: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

// ========================================
// ‚ù§Ô∏è INCR√âMENTER LES LIKES
// ========================================
function incrementLikes(data) {
  try {
    var sheet = SpreadsheetApp.openById('17fea_nma-6ZpZHa1fCfNBjJUSSvL1rRjwumruMO0-cM').getActiveSheet();
    var rows = sheet.getDataRange().getValues();
    var headers = rows[0];
    
    var idIndex = headers.indexOf('id');
    var likesIndex = headers.indexOf('likes');
    
    for (var i = 1; i < rows.length; i++) {
      if (String(rows[i][idIndex]) === String(data.id)) {
        var currentLikes = parseInt(rows[i][likesIndex]) || 0;
        var newLikes = currentLikes + 1;
        sheet.getRange(i + 1, likesIndex + 1).setValue(newLikes);
        
        return { success: true, newLikes: newLikes };
      }
    }
    
    throw new Error('Article non trouv√©: ' + data.id);
    
  } catch (error) {
    Logger.log('‚ùå Erreur incrementLikes: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

// ========================================
// üí¨ GESTION DES COMMENTAIRES
// ========================================
function addComment(data) {
  try {
    var commentSheet = SpreadsheetApp.openById('17fea_nma-6ZpZHa1fCfNBjJUSSvL1rRjwumruMO0-cM').getSheetByName('Commentaires');
    
    if (!commentSheet) {
      var ss = SpreadsheetApp.openById('17fea_nma-6ZpZHa1fCfNBjJUSSvL1rRjwumruMO0-cM');
      commentSheet = ss.insertSheet('Commentaires');
      commentSheet.appendRow(['id', 'article_id', 'author_name', 'author_email', 'comment_text', 'date', 'approved']);
    }
    
    var rows = commentSheet.getDataRange().getValues();
    var newId = rows.length;
    
    commentSheet.appendRow([
      newId,
      data.article_id,
      data.author_name,
      data.author_email,
      data.comment_text,
      new Date(),
      true
    ]);
    
    return { success: true, commentId: newId };
    
  } catch (error) {
    Logger.log('‚ùå Erreur addComment: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function getApprovedComments(articleId) {
  try {
    var commentSheet = SpreadsheetApp.openById('17fea_nma-6ZpZHa1fCfNBjJUSSvL1rRjwumruMO0-cM').getSheetByName('Commentaires');
    
    if (!commentSheet) {
      return { success: true, comments: [] };
    }
    
    var rows = commentSheet.getDataRange().getValues();
    var headers = rows[0];
    var comments = [];
    
    var articleIdIndex = headers.indexOf('article_id');
    var authorNameIndex = headers.indexOf('author_name');
    var commentTextIndex = headers.indexOf('comment_text');
    var dateIndex = headers.indexOf('date');
    
    for (var i = 1; i < rows.length; i++) {
      if (String(rows[i][articleIdIndex]) === String(articleId)) {
        comments.push({
          author_name: rows[i][authorNameIndex],
          comment_text: rows[i][commentTextIndex],
          date: rows[i][dateIndex]
        });
      }
    }
    
    return { success: true, comments: comments };
    
  } catch (error) {
    Logger.log('‚ùå Erreur getApprovedComments: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}